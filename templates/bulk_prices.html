<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الأسعار - لوحة التحكم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link href="/static/dashboard.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            {% include 'sidebar.html' %}

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Header -->
                <div class="dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 fw-bold"><i class="fas fa-money-bill-wave me-2"></i>إدارة الأسعار</h1>
                            <p class="text-muted mb-0">تحديث الأسعار بشكل جماعي باستخدام النسب المئوية أو أسعار الصرف</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="applyPriceChanges()">
                                <i class="fas fa-check me-2"></i>تطبيق التغييرات
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                <i class="fas fa-undo me-2"></i>إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Price Update Form -->
                <div class="row compact-section">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs me-2"></i> إعدادات تحديث الأسعار
                            </div>
                            <div class="card-body">
                                <form id="priceUpdateForm">
                                    <!-- Operation Type -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">نوع العملية:</label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="operation" id="percentageIncrease" value="percentage_increase" checked>
                                                <label class="form-check-label" for="percentageIncrease">
                                                    زيادة بنسبة مئوية
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="operation" id="percentageDecrease" value="percentage_decrease">
                                                <label class="form-check-label" for="percentageDecrease">
                                                    خصم بنسبة مئوية
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="operation" id="setPrice" value="set">
                                                <label class="form-check-label" for="setPrice">
                                                    تعيين سعر محدد
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="operation" id="currencyConversion" value="currency_conversion">
                                                <label class="form-check-label" for="currencyConversion">
                                                    تحويل العملة
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Value Input -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="mb-3" id="percentageValueGroup">
                                                <label class="form-label">قيمة النسبة المئوية:</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="percentageValue" value="10" min="0" max="100" step="0.1">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                                <div class="form-text">أدخل النسبة المئوية للزيادة أو الخصم</div>
                                            </div>
                                            
                                            <div class="mb-3" id="setPriceGroup" style="display: none;">
                                                <label class="form-label">السعر الجديد:</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="setPriceValue" value="0" min="0" step="0.01">
                                                    <span class="input-group-text">$</span>
                                                </div>
                                                <div class="form-text">أدخل السعر الجديد لجميع المنتجات المحددة</div>
                                            </div>
                                            
                                            <div class="mb-3" id="currencyGroup" style="display: none;">
                                                <label class="form-label">سعر الصرف:</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="currencyRate" value="1.0" min="0.1" step="0.01">
                                                    <span class="input-group-text">معامل التحويل</span>
                                                </div>
                                                <div class="form-text">مثال: إذا كان سعر الصرف 50، سيتم ضرب جميع الأسعار في 50</div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-calculator me-2"></i>معاينة التغييرات</h6>
                                                    <div id="previewResults">
                                                        <p class="text-muted mb-2">اختر العملية والقيمة لرؤية المعاينة</p>
                                                        <div id="previewExamples" class="small"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Product Selection -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <label class="form-label fw-bold">اختيار المنتجات:</label>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="productSelection" id="selectAll" value="all" checked>
                                                <label class="form-check-label" for="selectAll">
                                                    جميع المنتجات
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="productSelection" id="selectByCategory" value="by_category">
                                                <label class="form-check-label" for="selectByCategory">
                                                    حسب الفئة
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="productSelection" id="selectManual" value="manual">
                                                <label class="form-check-label" for="selectManual">
                                                    اختيار يدوي
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Category Selection -->
                                    <div class="row mb-4" id="categorySelectionGroup" style="display: none;">
                                        <div class="col-md-6">
                                            <label class="form-label">اختر الفئة:</label>
                                            <select class="form-select" id="categorySelect" multiple>
                                                {% for category in categories %}
                                                <option value="{{ category }}">{{ category }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="form-text">اضغط Ctrl لاختيار أكثر من فئة</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">المنتجات في الفئة المحددة:</label>
                                            <div id="categoryProductsList" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                                <p class="text-muted text-center mb-0">اختر فئة لعرض المنتجات</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Manual Selection -->
                                    <div class="row mb-4" id="manualSelectionGroup" style="display: none;">
                                        <div class="col-md-12">
                                            <label class="form-label">اختر المنتجات يدوياً:</label>
                                            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                                {% for category, products_list in products.items() %}
                                                <div class="category-products mb-3">
                                                    <h6 class="fw-bold text-primary">{{ category }}</h6>
                                                    {% for product in products_list %}
                                                    <div class="form-check">
                                                        <input class="form-check-input product-checkbox" type="checkbox" value="{{ product.id }}" id="product_{{ product.id }}">
                                                        <label class="form-check-label" for="product_{{ product.id }}">
                                                            {{ product.name }} - {{ product.price }}$
                                                            {% if product.model_number %}
                                                            <small class="text-muted">({{ product.model_number }})</small>
                                                            {% endif %}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllProducts()">
                                                    <i class="fas fa-check-square me-1"></i>تحديد الكل
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllProducts()">
                                                    <i class="fas fa-times-circle me-1"></i>إلغاء الكل
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Panel -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i> ملخص التغييرات
                            </div>
                            <div class="card-body">
                                <div id="summaryContent">
                                    <p class="text-muted">سيظهر هنا ملخص التغييرات بعد تعيين الإعدادات</p>
                                </div>
                                
                                <div class="mt-4">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>تنبيه:</strong> لا يمكن التراجع عن تغييرات الأسعار بعد التطبيق
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-success w-100" onclick="applyPriceChanges()">
                                        <i class="fas fa-check me-2"></i>تطبيق التغييرات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Preview -->
                <div class="card compact-section">
                    <div class="card-header">
                        <i class="fas fa-eye me-2"></i> معاينة المنتجات المتأثرة
                    </div>
                    <div class="card-body">
                        <div id="productsPreview">
                            <p class="text-muted text-center">سيتم عرض المنتجات المتأثرة بالتغييرات هنا</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="loading-spinner mb-3"></div>
                    <h6>جاري تطبيق التغييرات...</h6>
                    <p class="text-muted small">قد تستغرق العملية بضع ثوانٍ</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedProducts = new Set();
        let allProducts = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updatePreview();
            loadAllProducts();
        });

        function initializeEventListeners() {
            // Operation type change
            document.querySelectorAll('input[name="operation"]').forEach(radio => {
                radio.addEventListener('change', updateOperationUI);
            });

            // Product selection type change
            document.querySelectorAll('input[name="productSelection"]').forEach(radio => {
                radio.addEventListener('change', updateProductSelectionUI);
            });

            // Category selection change
            document.getElementById('categorySelect').addEventListener('change', updateCategoryProducts);

            // Value inputs change
            document.getElementById('percentageValue').addEventListener('input', updatePreview);
            document.getElementById('setPriceValue').addEventListener('input', updatePreview);
            document.getElementById('currencyRate').addEventListener('input', updatePreview);

            // Product checkbox changes
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('product-checkbox')) {
                    if (e.target.checked) {
                        selectedProducts.add(parseInt(e.target.value));
                    } else {
                        selectedProducts.delete(parseInt(e.target.value));
                    }
                    updatePreview();
                }
            });
        }

        function updateOperationUI() {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            
            // Hide all groups first
            document.getElementById('percentageValueGroup').style.display = 'none';
            document.getElementById('setPriceGroup').style.display = 'none';
            document.getElementById('currencyGroup').style.display = 'none';
            
            // Show relevant group
            if (operation === 'percentage_increase' || operation === 'percentage_decrease') {
                document.getElementById('percentageValueGroup').style.display = 'block';
            } else if (operation === 'set') {
                document.getElementById('setPriceGroup').style.display = 'block';
            } else if (operation === 'currency_conversion') {
                document.getElementById('currencyGroup').style.display = 'block';
            }
            
            updatePreview();
        }

        function updateProductSelectionUI() {
            const selection = document.querySelector('input[name="productSelection"]:checked').value;
            
            document.getElementById('categorySelectionGroup').style.display = 'none';
            document.getElementById('manualSelectionGroup').style.display = 'none';
            
            if (selection === 'by_category') {
                document.getElementById('categorySelectionGroup').style.display = 'block';
                updateCategoryProducts();
            } else if (selection === 'manual') {
                document.getElementById('manualSelectionGroup').style.display = 'block';
            }
            
            updatePreview();
        }

        function updateCategoryProducts() {
            const categorySelect = document.getElementById('categorySelect');
            const selectedCategories = Array.from(categorySelect.selectedOptions).map(opt => opt.value);
            const productsList = document.getElementById('categoryProductsList');
            
            if (selectedCategories.length === 0) {
                productsList.innerHTML = '<p class="text-muted text-center mb-0">اختر فئة لعرض المنتجات</p>';
                return;
            }
            
            let html = '';
            selectedProducts.clear();
            
            selectedCategories.forEach(category => {
                fetch(`/api/products/by_category/${category}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.products.forEach(product => {
                                selectedProducts.add(product.id);
                                html += `
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" checked onclick="return false;">
                                        <label class="form-check-label small">
                                            ${product.name} - ${product.price}$
                                        </label>
                                    </div>
                                `;
                            });
                        }
                        productsList.innerHTML = html || '<p class="text-muted text-center mb-0">لا توجد منتجات في هذه الفئة</p>';
                        updatePreview();
                    });
            });
        }

        function loadAllProducts() {
            {% for category, products_list in products.items() %}
                {% for product in products_list %}
                    allProducts.push({
                        id: {{ product.id }},
                        name: '{{ product.name }}',
                        price: {{ product.price }},
                        category: '{{ category }}',
                        model_number: '{{ product.model_number or "" }}'
                    });
                {% endfor %}
            {% endfor %}
        }

        function updatePreview() {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            const selection = document.querySelector('input[name="productSelection"]:checked').value;
            
            let affectedProducts = [];
            
            if (selection === 'all') {
                affectedProducts = allProducts;
            } else if (selection === 'by_category') {
                affectedProducts = allProducts.filter(p => selectedProducts.has(p.id));
            } else if (selection === 'manual') {
                affectedProducts = allProducts.filter(p => selectedProducts.has(p.id));
            }
            
            // Update summary
            updateSummary(operation, affectedProducts);
            
            // Update products preview
            updateProductsPreview(affectedProducts);
        }

        function updateSummary(operation, products) {
            const summaryContent = document.getElementById('summaryContent');
            const percentageValue = parseFloat(document.getElementById('percentageValue').value) || 0;
            const setPriceValue = parseFloat(document.getElementById('setPriceValue').value) || 0;
            const currencyRate = parseFloat(document.getElementById('currencyRate').value) || 1;
            
            if (products.length === 0) {
                summaryContent.innerHTML = '<p class="text-muted">لا توجد منتجات محددة</p>';
                return;
            }
            
            let summaryHTML = `
                <div class="mb-3">
                    <strong>عدد المنتجات المتأثرة:</strong> ${products.length}
                </div>
            `;
            
            if (operation === 'percentage_increase') {
                summaryHTML += `
                    <div class="mb-2">
                        <strong>نوع العملية:</strong> زيادة ${percentageValue}%
                    </div>
                    <div class="small text-muted">
                        سيتم زيادة أسعار جميع المنتجات المحددة بنسبة ${percentageValue}%
                    </div>
                `;
            } else if (operation === 'percentage_decrease') {
                summaryHTML += `
                    <div class="mb-2">
                        <strong>نوع العملية:</strong> خصم ${percentageValue}%
                    </div>
                    <div class="small text-muted">
                        سيتم خصم ${percentageValue}% من أسعار جميع المنتجات المحددة
                    </div>
                `;
            } else if (operation === 'set') {
                summaryHTML += `
                    <div class="mb-2">
                        <strong>نوع العملية:</strong> تعيين سعر ثابت
                    </div>
                    <div class="small text-muted">
                        سيتم تعيين سعر جميع المنتجات المحددة إلى ${setPriceValue}$
                    </div>
                `;
            } else if (operation === 'currency_conversion') {
                summaryHTML += `
                    <div class="mb-2">
                        <strong>نوع العملية:</strong> تحويل عملة
                    </div>
                    <div class="small text-muted">
                        سيتم ضرب جميع الأسعار في ${currencyRate}
                    </div>
                `;
            }
            
            summaryContent.innerHTML = summaryHTML;
        }

        function updateProductsPreview(products) {
            const previewContainer = document.getElementById('productsPreview');
            const operation = document.querySelector('input[name="operation"]:checked').value;
            const percentageValue = parseFloat(document.getElementById('percentageValue').value) || 0;
            const setPriceValue = parseFloat(document.getElementById('setPriceValue').value) || 0;
            const currencyRate = parseFloat(document.getElementById('currencyRate').value) || 1;
            
            if (products.length === 0) {
                previewContainer.innerHTML = '<p class="text-muted text-center">لا توجد منتجات لعرضها</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>المنتج</th><th>السعر الحالي</th><th>السعر الجديد</th><th>التغيير</th></tr></thead><tbody>';
            
            products.slice(0, 10).forEach(product => { // Show first 10 only
                let newPrice = product.price;
                
                if (operation === 'percentage_increase') {
                    newPrice = product.price * (1 + percentageValue/100);
                } else if (operation === 'percentage_decrease') {
                    newPrice = product.price * (1 - percentageValue/100);
                } else if (operation === 'set') {
                    newPrice = setPriceValue;
                } else if (operation === 'currency_conversion') {
                    newPrice = product.price * currencyRate;
                }
                
                newPrice = Math.round(newPrice * 100) / 100; // Round to 2 decimal places
                const change = newPrice - product.price;
                const changePercent = ((change / product.price) * 100).toFixed(1);
                
                html += `
                    <tr>
                        <td>
                            <small>${product.name}</small>
                            ${product.model_number ? `<br><code class="small">${product.model_number}</code>` : ''}
                        </td>
                        <td>${product.price}$</td>
                        <td><strong class="${change >= 0 ? 'text-success' : 'text-danger'}">${newPrice}$</strong></td>
                        <td>
                            <span class="badge bg-${change >= 0 ? 'success' : 'danger'}">
                                ${change >= 0 ? '+' : ''}${change.toFixed(2)}$ (${changePercent}%)
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            
            if (products.length > 10) {
                html += `<div class="text-center mt-2"><small class="text-muted">عرض 10 من ${products.length} منتج</small></div>`;
            }
            
            previewContainer.innerHTML = html;
        }

        function selectAllProducts() {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                selectedProducts.add(parseInt(checkbox.value));
            });
            updatePreview();
        }

        function deselectAllProducts() {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                selectedProducts.delete(parseInt(checkbox.value));
            });
            updatePreview();
        }

        function applyPriceChanges() {
            const operation = document.querySelector('input[name="operation"]:checked').value;
            const selection = document.querySelector('input[name="productSelection"]:checked').value;
            const percentageValue = parseFloat(document.getElementById('percentageValue').value) || 0;
            const setPriceValue = parseFloat(document.getElementById('setPriceValue').value) || 0;
            const currencyRate = parseFloat(document.getElementById('currencyRate').value) || 1;
            
            let productIds = [];
            
            if (selection === 'all') {
                productIds = allProducts.map(p => p.id);
            } else if (selection === 'by_category' || selection === 'manual') {
                productIds = Array.from(selectedProducts);
            }
            
            if (productIds.length === 0) {
                alert('❌ يرجى اختيار منتجات لتطبيق التغييرات عليها');
                return;
            }
            
            if (!confirm(`⚠️ هل أنت متأكد من تطبيق تغييرات الأسعار على ${productIds.length} منتج؟\n\nهذا الإجراء لا يمكن التراجع عنه!`)) {
                return;
            }
            
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            loadingModal.show();
            
            fetch('/api/update_bulk_prices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_ids: productIds,
                    operation: operation,
                    value: operation.includes('percentage') ? percentageValue : setPriceValue,
                    currency_rate: currencyRate
                })
            })
            .then(response => response.json())
            .then(data => {
                loadingModal.hide();
                
                if (data.success) {
                    alert(`✅ ${data.message}`);
                    if (data.errors && data.errors.length > 0) {
                        alert('⚠️ بعض الأخطاء occurred:\n' + data.errors.join('\n'));
                    }
                    location.reload();
                } else {
                    alert(`❌ ${data.message}`);
                }
            })
            .catch(error => {
                loadingModal.hide();
                alert('❌ حدث خطأ في الاتصال بالخادم');
            });
        }

        function resetForm() {
            if (confirm('هل تريد إعادة تعيين جميع الإعدادات؟')) {
                document.getElementById('priceUpdateForm').reset();
                selectedProducts.clear();
                updateOperationUI();
                updateProductSelectionUI();
                updatePreview();
            }
        }
    </script>
</body>
</html>