<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุชูุงุฑูุฑ ุงููุชูุฏูุฉ - ููุญุฉ ุงูุชุญูู</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link href="/static/dashboard.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sold-out-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .sold-out-badge {
            background-color: #28a745 !important;
            color: white !important;
        }
        
        .sold-out-row:hover {
            background-color: #ffeaa7 !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            {% include 'sidebar.html' %}

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Header -->
                <div class="dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 fw-bold"><i class="fas fa-chart-bar me-2"></i>ุงูุชูุงุฑูุฑ ุงููุชูุฏูุฉ</h1>
                            <p class="text-muted mb-0">ุชุญูููุงุช ุดุงููุฉ ูุฃุฏุงุก ุงููุชุฌุฑ ูุงููุจูุนุงุช ูุงููุฎุฒูู</p>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-file-export me-2"></i>ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/export/product_reports/excel">
                                    <i class="fas fa-file-excel text-success me-2"></i>ุชูุฑูุฑ ุงูููุชุฌุงุช (Excel)
                                </a></li>
                                <li><a class="dropdown-item" href="/export/inventory/excel">
                                    <i class="fas fa-file-excel text-success me-2"></i>ุชูุฑูุฑ ุงููุฎุฒูู (Excel)
                                </a></li>
                                <li><a class="dropdown-item" href="/export/customers/excel">
                                    <i class="fas fa-file-excel text-success me-2"></i>ุชูุฑูุฑ ุงูุนููุงุก (Excel)
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/export/inventory/csv">
                                    <i class="fas fa-file-csv text-info me-2"></i>ุชูุฑูุฑ ุงููุฎุฒูู (CSV)
                                </a></li>
                                <li><a class="dropdown-item" href="/export/customers/csv">
                                    <i class="fas fa-file-csv text-info me-2"></i>ุชูุฑูุฑ ุงูุนููุงุก (CSV)
                                </a></li>
                            </ul>
                            <button class="btn btn-outline-primary ms-2" onclick="refreshReports()">
                                <i class="fas fa-sync-alt me-2"></i>ุชุญุฏูุซ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                                <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Summary Stats -->
                <div class="stats-grid compact-section">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-number text-info">{{ sales_analytics.total_recent_orders }}</div>
                        <div class="stat-label">ุงูุทูุจุงุช (30 ููู)</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-number text-success">
                            {{ "{:,.0f}".format(sales_analytics.top_selling_products[0].revenue if sales_analytics.top_selling_products else 0) }}
                        </div>
                        <div class="stat-label">ุฃุนูู ููุชุฌ ุฅูุฑุงุฏุงู</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="stat-number text-warning">{{ inventory_analytics.total_products }}</div>
                        <div class="stat-label">ุฅุฌูุงูู ุงูููุชุฌุงุช</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" style="color: #8b5cf6;">
                            {{ product_performance|length }}
                        </div>
                        <div class="stat-label">ููุชุฌุงุช ููุนูุฉ</div>
                    </div>
                </div>

                <!-- Sales Performance -->
                <div class="row compact-section">
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-trophy me-2"></i> ุฃูุถู ุงูููุชุฌุงุช ุฃุฏุงุกู</span>
                                <select class="form-select form-select-sm" id="performanceMetric" style="width: auto;" onchange="updatePerformanceChart()">
                                    <option value="revenue">ุญุณุจ ุงูุฅูุฑุงุฏุงุช</option>
                                    <option value="quantity">ุญุณุจ ุงููููุฉ ุงููุจุงุนุฉ</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <canvas id="performanceChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-star me-2"></i> ุงูููุชุฌุงุช ุงูุฃูุซุฑ ูุจูุนุงู
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    {% for product in sales_analytics.top_selling_products[:5] %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong class="d-block">{{ product.name }}</strong>
                                            <small class="text-muted">{{ product.color }} - {{ product.size }}</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary rounded-pill">{{ product.total_sold }}</span>
                                            <br>
                                            <small class="text-success">{{ "{:,.0f}".format(product.revenue) }}$</small>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                                        <p class="text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูุนุงุช ุญุงููุงู</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Performance Reports -->
                <div class="card compact-section">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-pie me-2"></i> ุชูุงุฑูุฑ ุฃุฏุงุก ุงูููุชุฌุงุช</span>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm" id="reportSearch" placeholder="ุจุญุซ ูู ุงูููุชุฌุงุช...">
                            <select class="form-select form-select-sm" id="reportFilter" style="width: auto;">
                                <option value="all">ุฌููุน ุงูููุชุฌุงุช</option>
                                <option value="high_performance">ุฃุฏุงุก ุนุงูู</option>
                                <option value="low_performance">ุฃุฏุงุก ููุฎูุถ</option>
                                <option value="sold_out">ุชู ุงูุจูุน ุจุงููุงูู</option>
                                <option value="out_of_stock">ุบูุฑ ูุชููุฑ</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if product_performance %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="reportsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>ุงูููุชุฌ</th>
                                        <th>ุงููุฆุฉ</th>
                                        <th>ุงููููุฉ ุงูุฃูููุฉ</th>
                                        <th>ุงููุจุงุน</th>
                                        <th>ุงููุชุจูู</th>
                                        <th>ูุนุฏู ุงูุจูุน</th>
                                        <th>ุงูุฅูุฑุงุฏุงุช</th>
                                        <th>ุงูุฃุฏุงุก</th>
                                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in product_performance %}
                                    <tr class="{% if product.remaining_quantity == 0 and product.sold_quantity > 0 %}sold-out-row{% endif %}"
                                        data-category="{{ product.category }}" 
                                        data-performance="{{ (product.sold_quantity/product.initial_quantity*100 if product.initial_quantity > 0 else 0)|round(1) }}" 
                                        data-stock="{{ product.remaining_quantity }}"
                                        data-sold-out="{% if product.remaining_quantity == 0 and product.sold_quantity > 0 %}true{% else %}false{% endif %}">
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <strong>{{ product.name }}</strong>
                                            {% if product.model_number and product.model_number != 'ุบูุฑ ูุชููุฑ' %}
                                            <br><small class="text-muted">{{ product.model_number }}</small>
                                            {% endif %}
                                            {% if product.remaining_quantity == 0 and product.sold_quantity > 0 %}
                                            <br><span class="badge sold-out-badge">ุชู ุงูุจูุน ุจุงููุงูู โ</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ product.category }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ product.initial_quantity }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ product.sold_quantity }}</span>
                                        </td>
                                        <td>
                                            {% if product.remaining_quantity == 0 and product.sold_quantity > 0 %}
                                                <span class="badge sold-out-badge">0 โ</span>
                                            {% else %}
                                                <span class="badge bg-{{ 'success' if product.remaining_quantity > 10 else 'warning' if product.remaining_quantity > 0 else 'danger' }}">
                                                    {{ product.remaining_quantity }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if product.initial_quantity > 0 %}
                                                {% set sell_through_rate = (product.sold_quantity / product.initial_quantity * 100)|round(1) %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar 
                                                        {% if sell_through_rate > 70 %}bg-success
                                                        {% elif sell_through_rate > 30 %}bg-warning
                                                        {% else %}bg-danger{% endif %}" 
                                                        style="width: {{ sell_through_rate }}%">
                                                        {{ sell_through_rate }}%
                                                    </div>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-secondary">0%</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong class="text-success">{{ "{:,.0f}".format(product.total_revenue) }}$</strong>
                                        </td>
                                        <td>
                                            {% if product.remaining_quantity == 0 and product.sold_quantity > 0 %}
                                                <span class="badge sold-out-badge">ุชู ุงูุจูุน ุจุงููุงูู</span>
                                            {% elif product.initial_quantity > 0 %}
                                                {% set performance_rate = (product.sold_quantity / product.initial_quantity * 100)|round(1) %}
                                                {% if performance_rate > 70 %}
                                                    <span class="badge bg-success">ููุชุงุฒ</span>
                                                {% elif performance_rate > 40 %}
                                                    <span class="badge bg-warning">ุฌูุฏ</span>
                                                {% elif performance_rate > 0 %}
                                                    <span class="badge bg-info">ููุจูู</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">ูู ูุจุงุน</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-danger">ูุง ููุฌุฏ ูุฎุฒูู</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/products" class="btn btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button class="btn btn-outline-info" onclick="showProductDetails({{ product|tojson }})">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary of Sold Out Products -->
                        {% set sold_out_count = product_performance|selectattr('remaining_quantity', 'equalto', 0)|selectattr('sold_quantity', 'gt', 0)|list|length %}
                        {% if sold_out_count > 0 %}
                        <div class="alert alert-success mt-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-trophy fa-2x me-3"></i>
                                <div>
                                    <h6 class="alert-heading">ูุฌุงุญ ูู ุงููุจูุนุงุช! ๐</h6>
                                    <p class="mb-0">ููุงู <strong>{{ sold_out_count }}</strong> ููุชุฌ ุชู ุจูุนู ุจุงููุงูู - ูุฐุง ูุคุดุฑ ุฑุงุฆุน ุนูู ุฃุฏุงุก ุงููุชุฌุฑ!</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <p class="text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฏุงุก ุญุงููุงู</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Inventory Analytics -->
                <div class="row compact-section">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-box me-2"></i> ุชุญููู ุงููุฎุฒูู
                            </div>
                            <div class="card-body">
                                <canvas id="inventoryChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-exclamation-triangle me-2"></i> ุชูุจููุงุช ุงููุฎุฒูู
                            </div>
                            <div class="card-body">
                                <div class="alert-container">
                                    {% set sold_out_count = product_performance|selectattr('remaining_quantity', 'equalto', 0)|selectattr('sold_quantity', 'gt', 0)|list|length %}
                                    {% set out_of_stock_count = product_performance|selectattr('remaining_quantity', 'equalto', 0)|selectattr('sold_quantity', 'equalto', 0)|list|length %}
                                    
                                    {% if sold_out_count > 0 %}
                                    <div class="alert alert-success">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-trophy me-3"></i>
                                            <div>
                                                <h6 class="alert-heading">ููุชุฌุงุช ูุจุงุนุฉ ุจุงููุงูู โ</h6>
                                                <p class="mb-0">ููุงู {{ sold_out_count }} ููุชุฌ ุชู ุจูุนู ุจุงููุงูู - ูุคุดุฑ ูุฌุงุญ!</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if inventory_analytics.low_stock_items > 0 %}
                                    <div class="alert alert-warning">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exclamation-triangle me-3"></i>
                                            <div>
                                                <h6 class="alert-heading">ููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู</h6>
                                                <p class="mb-0">ููุงู {{ inventory_analytics.low_stock_items }} ุนูุตุฑ ุจูุฎุฒูู ุฃูู ูู 5 ูุทุน</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if out_of_stock_count > 0 %}
                                    <div class="alert alert-danger">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-times-circle me-3"></i>
                                            <div>
                                                <h6 class="alert-heading">ููุชุฌุงุช ุบูุฑ ูุชููุฑุฉ</h6>
                                                <p class="mb-0">ููุงู {{ out_of_stock_count }} ููุชุฌ ุบูุฑ ูุชููุฑ ููู ูุจุงุน ุจุนุฏ</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if inventory_analytics.low_stock_items == 0 and out_of_stock_count == 0 and sold_out_count == 0 %}
                                    <div class="alert alert-info">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check-circle me-3"></i>
                                            <div>
                                                <h6 class="alert-heading">ุงููุฎุฒูู ุจุญุงูุฉ ุฌูุฏุฉ</h6>
                                                <p class="mb-0">ุฌููุน ุงูููุชุฌุงุช ูุฏููุง ูุฎุฒูู ูุงูู</p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3">
                                    <h6>ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ:</h6>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="border rounded p-2">
                                                <div class="text-success fw-bold">{{ inventory_analytics.available_products }}</div>
                                                <small>ูุชุงุญุฉ</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="border rounded p-2">
                                                <div class="text-warning fw-bold">{{ inventory_analytics.low_stock_items }}</div>
                                                <small>ููุฎูุถุฉ</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="border rounded p-2">
                                                <div class="text-danger fw-bold">{{ out_of_stock_count }}</div>
                                                <small>ุบูุฑ ูุชููุฑุฉ</small>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="border rounded p-2">
                                                <div class="text-success fw-bold">{{ sold_out_count }}</div>
                                                <small>ูุจุงุนุฉ ุจุงููุงูู</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="row compact-section">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-excel fa-2x text-success mb-3"></i>
                                <h5>ุชูุฑูุฑ ุงูููุชุฌุงุช</h5>
                                <p class="text-muted small">ุชุตุฏูุฑ ุฃุฏุงุก ุงูููุชุฌุงุช ุฅูู Excel</p>
                                <a href="/export/product_reports/excel" class="btn btn-success btn-sm">
                                    <i class="fas fa-download me-2"></i>ุชุญููู Excel
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-users fa-2x text-info mb-3"></i>
                                <h5>ุชูุฑูุฑ ุงูุนููุงุก</h5>
                                <p class="text-muted small">ุชุตุฏูุฑ ุจูุงูุงุช ุงูุนููุงุก ุฅูู Excel</p>
                                <a href="/export/customers/excel" class="btn btn-info btn-sm">
                                    <i class="fas fa-download me-2"></i>ุชุญููู Excel
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-boxes fa-2x text-primary mb-3"></i>
                                <h5>ุชูุฑูุฑ ุงููุฎุฒูู</h5>
                                <p class="text-muted small">ุชุตุฏูุฑ ุจูุงูุงุช ุงููุฎุฒูู ุฅูู Excel</p>
                                <a href="/export/inventory/excel" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download me-2"></i>ุชุญููู Excel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailsTitle">ุชูุงุตูู ุฃุฏุงุก ุงูููุชุฌ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let performanceChart;
        let inventoryChart;

        // Initialize reports page
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupReportsSearch();
        });

        function initializeCharts() {
            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            
            const topProducts = {{ sales_analytics.top_selling_products|tojson }};
            const productNames = topProducts.slice(0, 5).map(p => p.name);
            const revenues = topProducts.slice(0, 5).map(p => p.revenue);
            const quantities = topProducts.slice(0, 5).map(p => p.total_sold);
            
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'ุงูุฅูุฑุงุฏุงุช ($)',
                        data: revenues,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'ุงููููุฉ ุงููุจุงุนุฉ',
                        data: quantities,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        type: 'line'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ุงูููุชุฌุงุช'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ุงูุฅูุฑุงุฏุงุช ($)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ุงููููุฉ ุงููุจุงุนุฉ'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    }
                }
            });

            // Inventory Chart
            const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
            const inventoryData = {{ inventory_analytics.category_stats|tojson }};
            
            const categories = Object.keys(inventoryData);
            const variants = categories.map(cat => inventoryData[cat].total_variants || 0);
            const lowStock = categories.map(cat => inventoryData[cat].low_stock || 0);
            const outOfStock = categories.map(cat => inventoryData[cat].out_of_stock || 0);
            
            inventoryChart = new Chart(inventoryCtx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [
                        {
                            label: 'ุฅุฌูุงูู ุงููุชุบูุฑุงุช',
                            data: variants,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ููุฎูุถุฉ ุงููุฎุฒูู',
                            data: lowStock,
                            backgroundColor: 'rgba(255, 159, 64, 0.6)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ููุชููุฉ ุงููุฎุฒูู',
                            data: outOfStock,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ุงููุฆุงุช'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'ุนุฏุฏ ุงูุนูุงุตุฑ'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true
                        }
                    }
                }
            });
        }

        function updatePerformanceChart() {
            const metric = document.getElementById('performanceMetric').value;
            const topProducts = {{ sales_analytics.top_selling_products|tojson }};
            
            if (metric === 'revenue') {
                performanceChart.data.datasets[0].data = topProducts.slice(0, 5).map(p => p.revenue);
                performanceChart.data.datasets[0].label = 'ุงูุฅูุฑุงุฏุงุช ($)';
                performanceChart.options.scales.y.title.text = 'ุงูุฅูุฑุงุฏุงุช ($)';
            } else {
                performanceChart.data.datasets[0].data = topProducts.slice(0, 5).map(p => p.total_sold);
                performanceChart.data.datasets[0].label = 'ุงููููุฉ ุงููุจุงุนุฉ';
                performanceChart.options.scales.y.title.text = 'ุงููููุฉ ุงููุจุงุนุฉ';
            }
            
            performanceChart.update();
        }

        function setupReportsSearch() {
            const searchInput = document.getElementById('reportSearch');
            const reportFilter = document.getElementById('reportFilter');
            const table = document.getElementById('reportsTable');
            
            if (!searchInput || !reportFilter || !table) return;
            
            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterType = reportFilter.value;
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const productName = row.querySelector('td:nth-child(2) strong').textContent.toLowerCase();
                    const modelNumber = row.querySelector('td:nth-child(2) small')?.textContent.toLowerCase() || '';
                    const category = row.getAttribute('data-category');
                    const performance = parseFloat(row.getAttribute('data-performance')) || 0;
                    const stock = parseInt(row.getAttribute('data-stock')) || 0;
                    const isSoldOut = row.getAttribute('data-sold-out') === 'true';
                    
                    const matchesSearch = productName.includes(searchTerm) || modelNumber.includes(searchTerm) || category.includes(searchTerm);
                    let matchesFilter = true;
                    
                    if (filterType === 'high_performance') {
                        matchesFilter = performance > 50;
                    } else if (filterType === 'low_performance') {
                        matchesFilter = performance <= 50 && performance > 0;
                    } else if (filterType === 'sold_out') {
                        matchesFilter = isSoldOut;
                    } else if (filterType === 'out_of_stock') {
                        matchesFilter = stock === 0 && !isSoldOut;
                    }
                    
                    row.style.display = matchesSearch && matchesFilter ? '' : 'none';
                });
            }
            
            searchInput.addEventListener('input', filterTable);
            reportFilter.addEventListener('change', filterTable);
        }

        function showProductDetails(product) {
            const modalTitle = document.getElementById('productDetailsTitle');
            const modalContent = document.getElementById('productDetailsContent');
            
            modalTitle.textContent = `ุชูุงุตูู ุฃุฏุงุก: ${product.name}`;
            
            const sellThroughRate = product.initial_quantity > 0 ? (product.sold_quantity / product.initial_quantity * 100).toFixed(1) : 0;
            const averagePrice = product.sold_quantity > 0 ? (product.total_revenue / product.sold_quantity).toFixed(2) : product.price;
            const isSoldOut = product.remaining_quantity === 0 && product.sold_quantity > 0;
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-info-circle me-2"></i> ูุนูููุงุช ุฃุณุงุณูุฉ
                            </div>
                            <div class="card-body">
                                <p><strong>ุงููุฆุฉ:</strong> ${product.category}</p>
                                <p><strong>ุฑูู ุงูููุฏูู:</strong> ${product.model_number || 'ุบูุฑ ูุชููุฑ'}</p>
                                <p><strong>ุงูุณุนุฑ:</strong> ${product.price}$</p>
                                <p><strong>ูุชูุณุท ุณุนุฑ ุงูุจูุน:</strong> ${averagePrice}$</p>
                                ${isSoldOut ? '<p><span class="badge sold-out-badge">ุชู ุงูุจูุน ุจุงููุงูู โ</span></p>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header ${isSoldOut ? 'bg-success' : 'bg-info'} text-white">
                                <i class="fas fa-chart-line me-2"></i> ุฃุฏุงุก ุงููุจูุนุงุช
                            </div>
                            <div class="card-body">
                                <p><strong>ุงููููุฉ ุงูุฃูููุฉ:</strong> ${product.initial_quantity}</p>
                                <p><strong>ุงููููุฉ ุงููุจุงุนุฉ:</strong> ${product.sold_quantity}</p>
                                <p><strong>ุงููููุฉ ุงููุชุจููุฉ:</strong> ${product.remaining_quantity}</p>
                                <p><strong>ูุนุฏู ุงูุจูุน:</strong> ${sellThroughRate}%</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-warning text-white">
                                <i class="fas fa-dollar-sign me-2"></i> ุงูุฃุฏุงุก ุงููุงูู
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <h3 class="text-success">${product.total_revenue.toLocaleString('en-US')}$</h3>
                                    <p class="text-muted">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</p>
                                </div>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar 
                                        ${sellThroughRate > 70 ? 'bg-success' : 
                                          sellThroughRate > 30 ? 'bg-warning' : 'bg-danger'}" 
                                        style="width: ${Math.min(sellThroughRate, 100)}%">
                                        ${sellThroughRate}% ูุนุฏู ุงูุจูุน
                                    </div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-primary">${product.initial_quantity}</div>
                                            <small>ูุฎุฒูู ุฃููู</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold text-success">${product.sold_quantity}</div>
                                            <small>ูุจุงุน</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <div class="fw-bold ${isSoldOut ? 'text-success' : product.remaining_quantity > 10 ? 'text-info' : 'text-danger'}">${product.remaining_quantity}</div>
                                            <small>${isSoldOut ? 'ูุจุงุน ุจุงููุงูู โ' : 'ูุชุจูู'}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
            modal.show();
        }

        function refreshReports() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุชุญุฏูุซ...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Export functions
        function exportReport(type, format) {
            let url = '';
            
            if (type === 'products') {
                url = format === 'excel' ? '/export/product_reports/excel' : '/export/inventory/csv';
            } else if (type === 'customers') {
                url = format === 'excel' ? '/export/customers/excel' : '/export/customers/csv';
            } else if (type === 'inventory') {
                url = '/export/inventory/excel';
            }
            
            if (url) {
                window.location.href = url;
            }
        }
    </script>
</body>
</html>