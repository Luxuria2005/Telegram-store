<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - LUXURIA FASHION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link href="/static/dashboard.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            {% include 'sidebar.html' %}

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Header -->
                <div class="dashboard-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 fw-bold"><i class="fas fa-user-clock me-2"></i>Ø³Ø¬Ù„Ø§Øª Ù†Ø´Ø§Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h1>
                            <p class="text-muted mb-0">ØªØªØ¨Ø¹ Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ</p>
                        </div>
                        <div class="alert alert-info mb-0" style="max-width: 350px;">
                            <small><i class="fas fa-lightbulb me-1"></i>Ù„Ø±Ø¤ÙŠØ© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª: Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯</small>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h5>
                                <h2 class="mb-0">{{ stats.total_activities }}</h2>
                                <small>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-tasks me-2"></i>Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h5>
                                <h2 class="mb-0">{{ stats.by_type|length }}</h2>
                                <small>Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ©</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-users me-2"></i>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</h5>
                                <h2 class="mb-0">{{ stats.by_user|length }}</h2>
                                <small>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0"><i class="fas fa-filter me-2"></i>ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h5>
                            <!-- âœ… NEW: Export and Reset Buttons -->
                            <div class="btn-group">
                                <a href="/export-client-logs?{{ request.query_string.decode('utf-8') }}" 
                                   class="btn btn-success btn-sm">
                                    <i class="fas fa-file-excel me-1"></i>ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                                </a>
                                <button type="button" class="btn btn-warning btn-sm" onclick="resetFilters()">
                                    <i class="fas fa-redo me-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="GET" action="/client-logs" class="row g-3" id="filterForm">
                            <div class="col-md-3">
                                <label class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„ (Telegram ID) <span class="text-danger">*</span></label>
                                <input type="number" name="telegram_id" class="form-control" value="{{ current_telegram_id or '' }}" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…">
                                <small class="text-muted">Ø£Ø¯Ø®Ù„ ID Ù„Ø±Ø¤ÙŠØ© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                                <select name="activity_type" class="form-select">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                    {% for activity_type in activity_types %}
                                    <option value="{{ activity_type }}" {% if current_activity_type == activity_type %}selected{% endif %}>
                                        {{ activity_type }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" name="start_date" class="form-control" value="{{ current_start_date }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" name="end_date" class="form-control" value="{{ current_end_date }}">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-2"></i>Ø¨Ø­Ø«
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- âœ… NEW: Client Interest Insights -->
                {% if current_telegram_id and not client_interests %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø£Ù†Ø´Ø·Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø¢Ø®Ø± 90 ÙŠÙˆÙ…. 
                    <br><small>Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø£Ùˆ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù†Ø´Ø·Ø© (ØªØµÙØ­ØŒ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©ØŒ Ø·Ù„Ø¨).</small>
                </div>
                {% endif %}
                {% if client_interests and current_telegram_id %}
                <div class="card mb-4 border-primary shadow-lg">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (ID: {{ current_telegram_id }})</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Shopping Behavior -->
                            <div class="col-md-6 mb-3">
                                <h6 class="text-primary"><i class="fas fa-shopping-bag me-2"></i>Ø³Ù„ÙˆÙƒ Ø§Ù„ØªØ³ÙˆÙ‚</h6>
                                <div class="list-group">
                                    <div class="list-group-item">
                                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØµÙØ­:</strong> {{ client_interests.shopping_behavior.total_browses }}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø³Ù„Ø©:</strong> {{ client_interests.shopping_behavior.total_cart_adds }}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</strong> {{ client_interests.shopping_behavior.total_orders }}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨:</strong> {{ client_interests.shopping_behavior.average_order_value }} {{ CURRENCY }}
                                    </div>
                                    <div class="list-group-item">
                                        <strong>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø§Ù„Ø³Ù„Ø©:</strong> {{ client_interests.shopping_behavior.cart_abandonment_rate }}%
                                    </div>
                                    {% if client_interests.shopping_behavior.most_active_day %}
                                    <div class="list-group-item">
                                        <strong>Ø£ÙƒØ«Ø± ÙŠÙˆÙ… Ù†Ø´Ø§Ø·:</strong> {{ client_interests.shopping_behavior.most_active_day }}
                                    </div>
                                    {% endif %}
                                    {% if client_interests.shopping_behavior.most_active_hour %}
                                    <div class="list-group-item">
                                        <strong>Ø£ÙƒØ«Ø± Ø³Ø§Ø¹Ø© Ù†Ø´Ø§Ø·:</strong> {{ client_interests.shopping_behavior.most_active_hour }}:00
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Product Interests -->
                            <div class="col-md-6 mb-3">
                                <h6 class="text-success"><i class="fas fa-heart me-2"></i>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©</h6>
                                {% if client_interests.cart_additions %}
                                <div class="list-group">
                                    {% for product, count in client_interests.cart_additions.items() %}
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>{{ product }}</span>
                                        <span class="badge bg-success">{{ count }} Ù…Ø±Ø©</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</p>
                                {% endif %}
                            </div>
                            
                            <!-- Color Preferences -->
                            {% if client_interests.favorite_colors %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-info"><i class="fas fa-palette me-2"></i>Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for color, count in client_interests.favorite_colors.items() %}
                                    <span class="badge bg-info p-2 mb-2">
                                        {{ color }} <span class="badge bg-light text-dark">{{ count }}</span>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Size Preferences -->
                            {% if client_interests.favorite_sizes %}
                            <div class="col-md-6 mb-3">
                                <h6 class="text-warning"><i class="fas fa-ruler me-2"></i>Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„Ø©</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for size, count in client_interests.favorite_sizes.items() %}
                                    <span class="badge bg-warning text-dark p-2 mb-2">
                                        {{ size }} <span class="badge bg-light text-dark">{{ count }}</span>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Logs Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø·</h5>
                    </div>
                    <div class="card-body">
                        {% if logs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</th>
                                        <th>Ø§Ù„ÙˆØµÙ</th>
                                        <th>Ø§Ù„Ù‡Ø¯Ù</th>
                                        <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in logs %}
                                    <tr>
                                        <td>
                                            <small>{{ log.created_at }}</small>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ log.first_name or 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' }} {{ log.last_name or '' }}</strong>
                                                    <br><small class="text-muted">@{{ log.username or 'Ø¨Ø¯ÙˆÙ†' }} | ID: {{ log.telegram_id }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ log.activity_type }}</span>
                                        </td>
                                        <td>{{ log.activity_description }}</td>
                                        <td>
                                            {% if log.target_name %}
                                            <strong>{{ log.target_type }}:</strong> {{ log.target_name }}
                                            {% if log.target_id %}
                                            <br><small class="text-muted">ID: {{ log.target_id }}</small>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.metadata %}
                                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#metadata{{ log.id }}">
                                                <i class="fas fa-info-circle"></i> Ø¹Ø±Ø¶
                                            </button>
                                            <div class="collapse mt-2" id="metadata{{ log.id }}">
                                                <div class="card card-body small">
                                                    <pre style="white-space: pre-wrap; font-size: 0.8rem;">{{ log.metadata }}</pre>
                                                </div>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©
                            <br><small class="mt-2 d-block">ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙˆØª (Ø§Ø¨Ø¯Ø£ØŒ ØªØµÙØ­ØŒ Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©) Ø«Ù… Ø§Ø¨Ø­Ø« Ø¹Ù† ID Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø±Ø¤ÙŠØ© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-expand interest insights if available
        {% if client_interests and current_telegram_id %}
        console.log('Client interests loaded for user {{ current_telegram_id }}');
        {% endif %}

        // âœ… NEW: Reset Filters Function
        function resetFilters() {
            // Reset form inputs
            document.getElementById('filterForm').reset();
            
            // Redirect to clean URL without parameters
            window.location.href = '/client-logs';
        }

        // âœ… NEW: Show loading state for export
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.querySelector('a[href*="export-client-logs"]');
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    // Show loading indicator
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
                    exportBtn.disabled = true;
                    
                    // Re-enable after 3 seconds in case of error
                    setTimeout(() => {
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                    }, 3000);
                });
            }
        });
    </script>
</body>
</html>